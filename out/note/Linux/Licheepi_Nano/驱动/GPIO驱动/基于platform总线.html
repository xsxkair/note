<!DOCTYPE html>

<html lang="en"  class="">


<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="keywords" content="">
    
    
    <meta name="description" content="">
    
    <meta name="generator" content="teedoc">
    <meta name="theme" content="teedoc-plugin-theme-default">
    
        
        <meta name="markdown-generator" content="teedoc-plugin-markdown-parser">
        
        <script>
MathJax = {"loader": {"load": ["output/svg"]}, "tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]]}, "svg": {"fontCache": "global"}};
</script>
        
        <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
        <script src="/note/static/js/theme_default/pre_main.js"></script>
        
        <link rel="stylesheet" href="/note/static/css/theme_default/prism.min.css" type="text/css"/>
        
        <link rel="stylesheet" href="/note/static/css/theme_default/viewer.min.css" type="text/css"/>
        
        <link rel="stylesheet" href="/note/static/css/theme_default/dark.css" type="text/css"/>
        
        <link rel="stylesheet" href="/note/static/css/theme_default/light.css" type="text/css"/>
        
        <script src="/note/static/js/theme_default/jquery.min.js"></script>
        
        <script src="/note/static/js/theme_default/split.js"></script>
        
        <link rel="stylesheet" href="/note/static/css/search/style.css" type="text/css"/>
        
        <link rel="stylesheet" href="/note/static/css/custom.css" type="text/css"/>
        
    
    
    <title>基于Platform驱动模型 - 云笔记</title>
    
    <script type="text/javascript">js_vars = {}</script>
</head>


<body class="type_doc">
    
    <div id="navbar">
        <div id="navbar_menu">
            <a class="site_title" href="/note/">
                
                    <img class="site_logo" src="/note/static/image/logo.png" alt="云笔记 logo">
                
                
                    <h2> </h2>
                
        </a>
            <a id="navbar_menu_btn"></a>
        </div>
        <div id="navbar_items">
            <div>
                <ul id="nav_left">
<li class="sub_items "><a >Linux</a><ul><li class=""><a  href="/note/Linux/Licheepi_Nano/说明.html">荔枝派Nano</a></li>
<li class=""><a  href="/note/Linux/Licheepi_Zero/说明.html">荔枝派Zero</a></li>
</ul>
</li>
</ul>

            </div>
            <div>
                <ul id="nav_right">
</ul>

                <ul class="nav_plugins"><li><a id="themes" class="light"></a></li></ul><ul class="nav_plugins"><li><a id="search"><span class="icon"></span><span class="placeholder">Search</span>
                            <div id="search_hints">
                                <span id="search_input_hint">Keywords separated by space</span>
                                <span id="search_loading_hint">Loading, wait please ...</span>
                                <span id="search_download_err_hint">Download error, please check network and refresh again</span>
                                <span id="search_other_docs_result_hint">Result from other docs</span>
                                <span id="search_curr_doc_result_hint">Result from current doc</span>
                            </div></a></li></ul>
            </div>
        </div>
    </div>
    
    <div id="wrapper">
        <div id="sidebar_wrapper">
            <div id="sidebar">
                <div id="sidebar_title">
                    
                </div>
                <ul class="show">
<li class="not_active with_link"><a href="/note/Linux/Licheepi_Nano/说明.html"><span class="label">说明</span><span class=""></span></a></li>
<li class="not_active no_link"><a><span class="label">系统编译</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/note/Linux/Licheepi_Nano/系统编译/编译U-boot.html"><span class="label">编译U-boot</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/Linux/Licheepi_Nano/系统编译/编译Linux.html"><span class="label">编译Linux</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/Linux/Licheepi_Nano/系统编译/编译BuildRoot.html"><span class="label">编译BuildRoot</span><span class=""></span></a></li>
</ul>
</li>
<li class="active_parent with_link"><a href="/note/Linux/Licheepi_Nano/no_translate.html?ref=驱动/GPIO驱动/系统自带驱动.html&from=/Linux/Licheepi_Nano/驱动/GPIO驱动/系统自带驱动.html"><span class="label">驱动开发</span><span class="sub_indicator"></span></a><ul class="show">
<li class="active_parent no_link"><a><span class="label">GPIO驱动</span><span class="sub_indicator"></span></a><ul class="show">
<li class="not_active with_link"><a href="/note/Linux/Licheepi_Nano/驱动/GPIO驱动/寄存器GPIO驱动.html"><span class="label">寄存器GPIO驱动</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/note/Linux/Licheepi_Nano/驱动/GPIO驱动/基于设备树.html"><span class="label">基于设备树</span><span class=""></span></a></li>
<li class="active with_link"><a href="/note/Linux/Licheepi_Nano/驱动/GPIO驱动/基于platform总线.html"><span class="label">基于platform总线</span><span class=""></span></a></li>
</ul>
</li>
</ul>
</li>
</ul>

            </div>
        </div>
        <div id="article">
            <div id="menu_wrapper">
                <div id="menu">
                </div>
            </div>
            <div id="content_wrapper">
                <div id="content_body">
                    <div id="article_head">
                        <div id="article_title">
                            
                            <h1>基于Platform驱动模型</h1>
                            
                        </div>
                        <div id="article_tags">
                            <ul>
                            
                            </ul>
                        </div>
                        <div id="article_info">
                        <div id="article_info_left">
                            <span class="article_author">
                                
                            </span>
                            
                                <span class="article_date" title="Last modify date: 2023-02-01">
                                    2023-02-01
                                </span>
                            
                        </div>
                        <div id="article_info_right">
                            
                        </div>
                        </div>
                    </div>
                    <div id="article_tools">
                        <span></span>
                        <span id="toc_btn"></span>
                    </div>
                    <div id="update_history">
                        
                    </div>
                    <div id="article_content">
                        
                            <h2 id="%E7%BC%96%E5%86%99%E8%AE%BE%E5%A4%87%E6%A0%91">编写设备树</h2>

<pre class="language-none"><code class="language-none">platform_led {
    	compatible = &quot;xsx,platform_led_dri&quot;;
    	#address-cells = &lt;1&gt;;
    	#size-cells = &lt;1&gt;;
    	reg = &lt;0X01C20800 0x04 0X01C20810 0x04&gt;;
    	status = &quot;okay&quot;;
    };
</code></pre>
<h2 id="%E7%BC%96%E5%86%99%E9%A9%B1%E5%8A%A8">编写驱动</h2>

<pre class="language-none"><code class="language-none">#include &lt;linux/module.h&gt;
#include &lt;linux/kernel.h&gt;
#include &lt;linux/fs.h&gt;
#include &lt;linux/init.h&gt;
#include &lt;linux/io.h&gt;
#include &lt;linux/uaccess.h&gt;
#include &lt;linux/device.h&gt;
#include &lt;linux/cdev.h&gt;
#include &lt;linux/platform_device.h&gt;
#include &lt;linux/of.h&gt;
#include &lt;linux/of_platform.h&gt;
#include &lt;linux/of_address.h&gt;

static dev_t led_dev_num;         // 定义一个设备号
static struct cdev *led_cdev;     // 定义一个设备管理结构体指针
static struct class *led_class;   // 定义一个设备类
static struct device *led_device; // 定义一个设备

volatile unsigned long *gpio_a_cfg0;
volatile unsigned long *gpio_a_data;

static int led_open(struct inode *inode, struct file *file)
{
    *((volatile size_t *)gpio_a_cfg0) &amp;= ~(7 &lt;&lt; 0); // 清除配置寄存器
    *((volatile size_t *)gpio_a_cfg0) |= (1 &lt;&lt; 0);  // 配置GPIOE10为输出模式

    return 0;
}

static int led_close(struct inode *inode, struct file *file)
{
    return 0;
}

static int led_read(struct file *filp, char __user *buff, size_t count, loff_t *off)
{
    int res;
    size_t status = *((volatile size_t *)gpio_a_data);

    // 将内核空间数据拷贝到用户空间
    // statue =&gt; buff, 大小4字节
    res = copy_to_user(buff, &amp;status, 4);
    if (res &lt; 0)
        printk(KERN_DEBUG &quot;read error!!!\r\n&quot;);
    else
        printk(KERN_DEBUG &quot;read ok!!!\r\n&quot;);

    return res;
}

static int led_write(struct file *filp, const char __user *buff, size_t count, loff_t *offp)
{
    int res = 0;
    size_t statue = 0;

    res = copy_from_user(&amp;statue, buff, 4);
    if (res &lt; 0)
    {
        printk(KERN_DEBUG &quot;write error!!!\r\n&quot;);
        return 0;
    }

    if (!!statue)
        *((volatile size_t *)gpio_a_data) |= (1 &lt;&lt; 0);
    else
        *((volatile size_t *)gpio_a_data) &amp;= ~(1 &lt;&lt; 0);

    return 1;
}

static struct file_operations led_ops = {
    .owner = THIS_MODULE,
    .open = led_open,
    .read = led_read,
    .write = led_write,
    .release = led_close,
};

static int led_probe(struct platform_device * pdev)
{
    struct resource * res;
    int ret;

    led_cdev = cdev_alloc();    //动态申请一个设备结构体
    if(led_cdev == NULL) {
        printk(KERN_WARNING &quot;cdev alloc fail!!\r\b&quot;);
        return -1;
    }

    ret = alloc_chrdev_region(&amp;led_dev_num, 0, 1, &quot;led_num&quot;);//动态申请一个设备号
    if(ret != 0) {
        printk(KERN_WARNING &quot;alloc_chrdev_region fail!!\r\b&quot;);
        return -2;
    }

    led_cdev-&gt;owner = THIS_MODULE;
    led_cdev-&gt;ops = &amp;led_ops;
    cdev_add(led_cdev, led_dev_num, 1);    //将设备添加到内核中

    led_class = class_create(THIS_MODULE, &quot;led_class&quot;);
    if(led_class == NULL) {
        printk(KERN_WARNING &quot;class_create fail!!\r\b&quot;);
        return -3;
    }

//这个名字会作为驱动设备的文件名
    led_device = device_create(led_class, NULL, led_dev_num, NULL, &quot;led_device&quot;);
    if(IS_ERR(led_device)) {
        printk(KERN_WARNING &quot;device_create fail!!\r\b&quot;);
        return -4;
    }

    res = platform_get_resource(pdev, IORESOURCE_MEM, 0);
    gpio_a_cfg0 = ioremap(res-&gt;start, res-&gt;end - res-&gt;start + 1);

    res = platform_get_resource(pdev, IORESOURCE_MEM, 1);
    gpio_a_data = ioremap(res-&gt;start, res-&gt;end - res-&gt;start + 1);

    return 0;
}

static int led_remove(struct platform_device * pdev)
{
    iounmap(gpio_a_cfg0);
    iounmap(gpio_a_data);

    cdev_del(led_cdev);
    unregister_chrdev_region(led_dev_num, 1);
    device_destroy(led_class, led_dev_num);
    class_destroy(led_class);

    return 0;
}

//优先级高：匹配设备树中compatible属性全部
static struct of_device_id led_match_table[]={
    {
        .compatible = &quot;xsx,platform_led_dri&quot;,
    },
    {},
};
//优先级低于of_match_table：匹配设备树中compatible属性中的设备名
static struct platform_device_id led_device_ids[]={
    {
        .name=&quot;platform_led_dri&quot;,
    },
    {},
};

static struct platform_driver led_driver={
    .probe = led_probe,
    .remove = led_remove,
    .driver = {
        .name = &quot;led&quot;,
        .of_match_table = led_match_table,
    },
    .id_table = led_device_ids,
};

static int led_driver_init(void)
{
    platform_driver_register(&amp;led_driver);

    return 0;
}

static void led_driver_exit(void){
    platform_driver_unregister(&amp;led_driver);
}

module_init(led_driver_init);
module_exit(led_driver_exit);

MODULE_LICENSE(&quot;GPL&quot;);          //不加的话加载会有错误提醒
MODULE_AUTHOR(&quot;1477153217@qq.com&quot;);     //作者
MODULE_VERSION(&quot;0.1&quot;);          //版本
MODULE_DESCRIPTION(&quot;led_driver&quot;);  //简单的描述

</code></pre>

<pre class="language-none"><code class="language-none">#在makefile中加入
obj-y		+= xsx_platform_led.o

#然后编译烧录系统即可在/dev下发现led_device文件
</code></pre>
<h2 id="%E6%B5%8B%E8%AF%95%E7%A8%8B%E5%BA%8F">测试程序</h2>

<pre class="language-none"><code class="language-none">#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;

int main(int argc, char **argv)
{
    int fd;
    char *filename = NULL;
    int val, cnt, i;

    filename = argv[1];
    fd = open(filename, O_RDWR);
    if (fd &lt; 0)
    {
        printf(&quot;err, can`t open %s\r\n&quot;, filename);
        return 0;
    }

    if (argc != 3)
    {
        printf(&quot;usage: ./led_app.exe [device] [次数]\r\n&quot;);
    }

    cnt = strtol(argv[2], NULL, 10);
    for (i = 0; i &lt; cnt; i++)
    {
        val = 0;
        write(fd, &amp;val, 4);
        sleep(1);

        val = 1;
        write(fd, &amp;val, 4);
        sleep(1);
    }

    close(fd);
    return 0;
}
</code></pre>

<pre class="language-none"><code class="language-none">#编译app
arm-linux-gcc led_test.c -o led_test_app.o

#下载到板子上
chmod 777 ./led_test_app.o
./led_test_app.o /dev/led_device 10
LED即可闪烁10次
</code></pre>

                        
                    </div>
                </div>
                <div id="previous_next">
                    <div id="previous">
                        
                        <a href="/note/Linux/Licheepi_Nano/驱动/GPIO驱动/基于设备树.html">
                            <span class="icon"></span>
                            <span class="label">基于设备树</span>
                        </a>
                        
                    </div>
                    <div id="next">
                        
                    </div>
                </div>
                <div id="comments-container"></div>
            </div>
            <div id="toc_wrapper">
                <div id="toc">
                    <div id="toc_content">
                            
                    </div>
                </div>
            </div>
        </div>
    </div>
    <a id="to_top" href="#"></a>
    <div id="doc_footer">
        <div id="footer">
            <div id="footer_top">
                <ul>
<li><a></a><ul><li><a target="_blank" href="/note/#"></a></li>
</ul>
</li>
</ul>

            </div>
            <div id="footer_bottom">
                <ul>
<li><a target="_blank" href="https://github.com/teedoc/teedoc">Generated by teedoc</a></li>
</ul>

            </div>
        </div>
    </div>
    
        <script src="/note/teedoc-plugin-markdown-parser/mermaid.min.js"></script>
    
        <script>mermaid.initialize({startOnLoad:true});</script>
    
        <script src="/note/static/js/theme_default/tocbot.min.js"></script>
    
        <script src="/note/static/js/theme_default/main.js"></script>
    
        <script src="/note/static/js/theme_default/viewer.min.js"></script>
    
        <script src="/note/static/css/theme_default/prism.min.js"></script>
    
        <script src="/note/static/js/search/search_main.js"></script>
    
        <script src="/note/static/js/custom.js"></script>
    
</body>

</html>